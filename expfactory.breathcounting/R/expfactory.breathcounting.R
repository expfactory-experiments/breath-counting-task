globalVariables(c('.'))

#' expfactory.breathcounting: A package for processing breath counting data.
#'
#' This package processes data generated from a breath counting task
#' which is a behavioural measure of mindfulness. The package can analyse data from the
#' original ePrime task, and a version which runs in a web browser. The latter version
#' was designed to be used within The Experiment Factory framework.
#'
#' @section expfactory.breathcounting functions:
#' ...
#' @references Levinson, D. B., Stoll, E. L., Kindy, S. D., Merry, H. L., and Davidson, R. J. (2014). A mind you can count on: validating breath counting as a behavioral measure of
#' mindfulness. Frontiers in Psychology, 5.
#'
#' @docType package
#' @name expfactory.breathcounting
NULL

#' Calculate breath counting accuracy for a group of participants
#'
#' Calculate breath counting accuracy for a group of participants.
#' @param df Data frame. Breath counting accuracy for participants
#' @param c String. Column to group by
#' @importFrom dplyr group_by_at ungroup group_modify
#' @export
#' @return Data frame
bc_all_accuracy <- function(df, c='subject') {
  accuracy <- df %>%
    group_by_at(c) %>%
    group_modify(bc_accuracy) %>%
    ungroup()
}

#' Convert ePrime or Experiment Factory breath counting data to data frame
#'
#' Convert ePrime or Experiment Factory breath counting data to data frame.
#' @param data_path Path to data files
#' @param type String ('expfactory' or 'eprime, default='expfactory')
#' @param format String ('csv' or 'json', default='json')
#' @param participants Data frame
#' @param t Numeric Time point
#' @importFrom magrittr %>%
#' @importFrom dplyr group_by ungroup left_join do select mutate rename
#' @importFrom rlang .data
#' @importFrom utils write.csv
#' @export
#' @return Data frame
breath_counting <- function(data_path, type='expfactory', format='json', participants, t) {
  if (type == 'eprime') {
    df <- bc_process_eprime(data_path)
  } else if (type == 'expfactory') {
    if (format == 'csv') {
      df <- bc_process_expfactory(data_path, t)
    } else { # expfactory, format == json
      df <- expand.grid(token = participants$token) %>%
        mutate(path=paste0(data_path, '/', .data$token, '_finished/breath-counting-task-results.json')) %>%
        group_by(.data$path) %>%
        do(., bc_process_expfactory_file(.data$path, .data$token)) %>%
        rename(token = .data$p) %>%
        ungroup()
      df <- left_join(participants, df, by = 'token') %>%
        select(.data$p, .data$Sample, .data$response, .data$rt)
    }
  }
  return(df)
}

#' Process Experiment Factory breath counting data files
#'
#' Process Experiment Factory breath counting data files.
#' @param path Path to data files
#' @param t Time point
#' @importFrom magrittr %>%
#' @importFrom dplyr rowwise filter do select mutate
#' @importFrom rlang .data
#' @export
#' @return Data frame
bc_process_expfactory <- function(path, t) {
  paths <-list.files(path, pattern = ".*_bc.csv", full.names = TRUE, recursive = TRUE)
  df <- expand.grid(path=paths, time=t, stringsAsFactors = FALSE) %>%
    group_by(.data$path) %>%
    mutate(p=as.integer(gsub(".*/.*/(\\d+)/.*$", '\\1', path))) %>%
    do(., bc_process_expfactory_file(.data$path, .data$p, json=FALSE)) %>%
    ungroup()
  return(df)
}

#' Process Experiment Factory breath counting task data file
#'
#' \code{process_breath_counting()} processes data files generated by the Breath Counting Task
#' (\url{https://expfactory-experiments.github.io/breath-counting-task/}).
#'
#' @param path Path to data file
#' @param p Participant identifier
#' @param json Boolean indicating whether data format is JSON (TRUE), default or CSV (FALSE)
#' @keywords expfactory mindfulness breath
#' @importFrom dplyr filter mutate rename select
#' @importFrom expfactory process_expfactory_experiment
#' @importFrom rlang .data
#' @importFrom utils read.csv
#' @export
#' @return Data frame
bc_process_expfactory_file <- function(path, p, json = TRUE) {
  if(!file.exists(path)){
    return(data.frame(p=p, path=path))
  }
  if (json) {
    bc <- process_expfactory_experiment(path)
  } else {
    bc <- read.csv(path, header = TRUE)
  }
  bc %>% filter(.data$trial_id == 'breath_counting') %>%
    select(.data$trial_index, .data$rt, .data$key_press) %>%
    # rename column headers to match those from original ePrime task so breath_counting_accuracy() can handle both
    rename(Sample = .data$trial_index, response = .data$key_press) %>%
    mutate(Sample = .data$Sample - 2,
           response = ifelse(.data$response == 40, '{DOWNARROW}', '{RIGHTARROW}'), p = p)
}

#' Process ePrime breath counting data files
#'
#' Process ePrime breath counting data files.
#' @param path Path to ePrime data files
#' @importFrom utils write.table
#' @importFrom dplyr do group_by ungroup
#' @importFrom rlang .data
#' @export
#' @return Data frame
bc_process_eprime <- function(path) {
  paths <- list.files(path, pattern = ".txt", full.names = TRUE, recursive = TRUE)
  df <- expand.grid(path=paths, stringsAsFactors=FALSE) %>%
    group_by(path) %>%
    do(., bc_process_eprime_file(.data$path)) %>%
    ungroup()
  return(df)
}

#' Process ePrime breath counting data file
#'
#' Process ePrime breath counting data file.
#' (Levinson, Stoll, Kindy, Merry, & Davidson, 2014)
#' @param path Path to ePrime data file
#' @keywords ePrime
#' @importFrom dplyr across add_row rename
#' @importFrom rlang .data
#' @importFrom rprime FrameList keep_levels read_eprime to_data_frame
#' @export
#' @return Data frame
bc_process_eprime_file <- function(path) {
  lines  <- read_eprime(path)
  frames <- FrameList(lines)
  frame1 <- frames[[1]]

  # trials occur at level 3
  frames     <- keep_levels(frames, 3)
  df         <- to_data_frame(frames)
  to_pick    <- c("Sample", "Wait4TUTSlide.RESP", "Wait4TUTSlide.RT")
  df         <- df[to_pick]
  df$subject <- frame1$Subject
  df <- rename(df, response = .data$Wait4TUTSlide.RESP, rt = .data$Wait4TUTSlide.RT) %>%
    mutate(across(c(Sample, rt, subject), as.integer))
  # Add initial {DOWNARROW} to correct for a known issue in the ePrime script provided by Daniel Levinson,
  # which doesn't record the first keypress (I think) on the first trial.  Bug requires a bit more testing
  # to confirm it's the _initial_ keypress which is lost, but it definitely omits 1 {DOWNARROW} keypress.
  df <- add_row(df, .before = 1, Sample = 0, response = '{DOWNARROW}', rt = 0, subject = df$subject[1])
  df
}

#' Calculate breath counting accuracy
#'
#' Calculate breath counting accuracy
#' (Levinson, Stoll, Kindy, Merry, & Davidson, 2014)
#' @param df Data frame containing breath counting data
#' @param y Tibble Grouping variable (see group_modify())
#' @keywords breath counting meditation mindfulness
#' @export
#' @return Data frame
bc_accuracy <- function(df, y) {
  resp      <- 1
  row       <- 1
  total     <- 0
  correct   <- 0
  incorrect <- 0
  repeat {
    if (resp < 9) {
      if (df[row,'response'] == '{DOWNARROW}') { # correct
        resp <- resp + 1
      } else if (df[row,'response'] == '{RIGHTARROW}') {
        total     <- total + 1
        incorrect <- incorrect + 1
        resp      <- 1 # reset count
      } else {
        # shouldn't get here
      }
    } else { # response >= 9
      # We only record complete 9 counts (i.e. any final partial count isn't included)
      if (df[row,'response'] == '{RIGHTARROW}') {
        if (resp == 9 ) { # correct!
          correct <- correct + 1
        }
        # -> signals end of the count set, regardless of whether it was on breath 9 or later
        total <- total + 1
        resp  <- 1
      } else if (df[row,'response'] == '{DOWNARROW}') {
        if (resp == 9 ) { # incorrect
          incorrect <- incorrect + 1
        }
        # keep counting responses until the next {RIGHTARROW} ends the count set
        resp <- resp + 1
      } else {
        # shouldn't get here
      }
    }
    row <- row + 1
    if (row > nrow(df)) {
      break
    }
  }
  data.frame(responses=row-1,total,correct,incorrect)
}
