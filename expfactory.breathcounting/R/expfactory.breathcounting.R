#' Convert Experiment Factory breath counting data to CSV
#'
#' Convert Experiment Factory breath counting data to CSV
#' @param path Path to data files
#' @param t Time point
#' @param exclude Participants to exclude
#' @export
expfactory_breath_counting_to_csv <- function(path, t, exclude) {
  # make a bc.csv consumable by breath_counting_accuracy()
  paths <-
    list.files(path,
               pattern = ".*_bc.csv",
               full.names = TRUE,
               recursive = TRUE)
  df <- expand.grid(path=paths, time=t, stringsAsFactors = FALSE) %>%
    rowwise() %>%
    mutate(p=as.integer(gsub(".*/.*/(\\d+)/.*$", '\\1', path))) %>%
    filter(! p %in% exclude ) %>%
    do(., process_breath_counting(.$path, .$p, json=FALSE))
  write.table(df, paste(path, '/bc.csv', sep=''), sep = ",", row.names = FALSE)
}

#' Process Breath Counting Task data file
#'
#' \code{process_breath_counting()} processes data files generated by the Breath Counting Task
#' (\url{https://expfactory-experiments.github.io/breath-counting-task/}).
#'
#'@examples
#'\dontrun{
#'bc <- expand.grid(token = participants$token) %>%
#'  rowwise() %>%
#'  mutate(path=paste0(data_dir, '/', token, '_finished/breath-counting-task-results.json')) %>%
#'  do(., process_breath_counting(.$path, .$token))
#'}
#' @param path Path to data file
#' @param p Participant identifier
#' @param json=TRUE Boolean indicating whether ANT data format is JSON (TRUE) or CSV (FALSE)
#' @keywords expfactory mindfulness breath
#' @export
#' @return Data frame
process_breath_counting <- function(path, p, json=TRUE) {
  if(!file.exists(path)){
    return(data_frame(p=p, path=path))
  }
  if (json) {
    bc <- expfactory::process_expfactory_experiment(path)
  } else {
    bc <- read.csv(path, header = TRUE)
  }
  bc %>% filter(trial_id == 'breath_counting') %>%
    select(trial_index,rt,key_press) %>%
    # rename column headers to match those from original ePrime task so breath_counting_accuracy() can handle both
    dplyr::rename(Sample = trial_index, response = key_press) %>%
    mutate(Sample = Sample - 2, response = ifelse(response == 40, '{DOWNARROW}', '{RIGHTARROW}'), p = p)
}

#' Convert ePrime breath counting data to CSV
#'
#' Convert ePrime breath counting data to CSV
#' @param path Path to ePrime data files
#' @export
eprime_breath_counting_to_csv <- function(path) {
  paths <- list.files(path, pattern = ".txt", full.names = TRUE, recursive = TRUE)
  df <- expand.grid(path=paths, stringsAsFactors=FALSE) %>%
    rowwise() %>%
    do(., process_eprime_file(.$path))
  write.table(df, paste(path, '/bc.csv', sep=''), sep = ",", row.names = FALSE)
}

#' Process ePrime Breath Counting Data File
#'
#' Process ePrime breath counting data file
#' (Levinson, Stoll, Kindy, Merry, & Davidson, 2014)
#' @param path Path to ePrime data file
#' @keywords ePrime
#' @export
process_eprime_file <- function(path) {
  lines  <- rprime::read_eprime(path)
  frames <- rprime::FrameList(lines)
  frame1 <- frames[[1]]

  # trials occur at level 3
  frames     <- rprime::keep_levels(frames, 3)
  df         <- rprime::to_data_frame(frames)
  to_pick    <- c("Sample", "Wait4TUTSlide.RESP", "Wait4TUTSlide.RT")
  df         <- df[to_pick]
  df$subject <- frame1$Subject
  df <- dplyr::rename(df, response = Wait4TUTSlide.RESP, rt = Wait4TUTSlide.RT)
  # Add initial {DOWNARROW} to correct for a known issue in the ePrime script provided by Daniel Levinson,
  # which doesn't record the first keypress (I think) on the first trial.  Bug requires a bit more testing
  # to confirm it's the _initial_ keypress which is lost, but it definitely omits 1 {DOWNARROW} keypress.
  df <- add_row(df, .before = 1, Sample = 0, response = '{DOWNARROW}', rt = 0, subject = df$subject[1])
  df
}

#' Breath Counting Accuracy
#'
#' Process ePrime breath counting data
#' (Levinson, Stoll, Kindy, Merry, & Davidson, 2014)
#' @param df Breath counting data frame
#' @keywords breath counting meditation mindfulness
#' @export
breath_counting_accuracy <- function(df) {
  resp      <- 1
  row       <- 1
  total     <- 0
  correct   <- 0
  incorrect <- 0
  repeat {
    if (resp < 9) {
      if (df[row,'response'] == '{DOWNARROW}') { # correct
        resp <- resp + 1
      } else if (df[row,'response'] == '{RIGHTARROW}') {
        total     <- total + 1
        incorrect <- incorrect + 1
        resp <- 1 # reset count
      } else {
        # shouldn't get here
      }
    } else { # response >= 9
      # We only record complete 9 counts (i.e. any final partial count isn't included)
      if (df[row,'response'] == '{RIGHTARROW}') {
        if (resp == 9 ) { # correct!
          correct <- correct + 1
        }
        # -> signals end of the count set, regardless of whether it was on breath 9 or later
        total <- total + 1
        resp  <- 1
      } else if (df[row,'response'] == '{DOWNARROW}') {
        if (resp == 9 ) { # incorrect
          incorrect <- incorrect + 1
        }
        # keep counting responses until the next {RIGHTARROW} ends the count set
        resp <- resp + 1
      } else {
        # shouldn't get here
      }
    }
    row <- row + 1
    if (row > nrow(df)) {
      break
    }
  }
  data.frame(total,correct,incorrect)
}
